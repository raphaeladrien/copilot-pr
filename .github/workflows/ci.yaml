name: Copilot AI PR Review

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
     
      - name: Install GitHub CLI
        run: |
            sudo apt update
            sudo apt install gh jq -y
    
      - name: Get PR Diff
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > pr.diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
      - name: Build Review Input
        run: |
          if [ -f .github/ai/copilot-pr-review.prompt.md ]; then
            cat .github/ai/copilot-pr-review.prompt.md > review_input.txt
          else
            echo "Please review the following PR changes and provide feedback:" > review_input.txt
          fi
          printf "\n\nPR DIFF:\n\n" >> review_input.txt
          cat pr.diff >> review_input.txt

      - name: Call GitHub Models API
        run: |
          PROMPT=$(jq -Rs . < review_input.txt)
          
          curl -X POST https://models.inference.ai.azure.com/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -d '{
              "messages": [
                {
                  "role": "system",
                  "content": "You are a helpful code reviewer. Provide constructive feedback on code changes."
                },
                {
                  "role": "user",
                  "content": '"$PROMPT"'
                }
              ],
              "model": "gpt-4o",
              "temperature": 0.7,
              "max_tokens": 2000
            }' > review_output.json

      - name: Debug API Response
        if: always()
        run: |
          echo "=== Full API Response ==="
          cat review_output.json | jq '.'

      - name: Extract Review Text
        run: |
          cat review_output.json | jq -r '.choices[0].message.content' > review.md
          
          if [ ! -s review.md ] || [ "$(cat review.md)" = "null" ]; then
            echo "Failed to extract review. API Response:" > review.md
            cat review_output.json >> review.md
          fi
          
          echo "=== Extracted Review ==="
          cat review.md

      - name: Post PR Comment
        run: |
          if [ -s review.md ] && [ "$(cat review.md)" != "null" ]; then
            gh pr comment ${{ github.event.pull_request.number}} --body-file review.md
          else
            echo "ERROR: No valid review content"
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
